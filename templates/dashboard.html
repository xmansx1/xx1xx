<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحتي – تطوع من أجلي</title>

  <!-- Tailwind للـMVP -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--primary:#059669;--primary-dark:#047857}
    body{font-family:'Cairo',system-ui}
    .dashboard-card{background:#fff;border:1px solid #e2e8f0;border-radius:1rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);transition:.3s}
    .dashboard-card:hover{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .request-card{border:1px solid #e2e8f0;border-radius:.75rem;transition:.3s}
    .request-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1);border-color:var(--primary)}
    .badge{padding:.25rem .75rem;border-radius:9999px;font-size:.75rem;font-weight:700}
    .badge-assigned{background:#d1fae5;color:#065f46}
    .badge-available{background:#fef3c7;color:#92400e}
    .empty-state{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:.75rem}
    .stats-card{background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);border:1px solid #e2e8f0;border-radius:1rem;transition:.3s}
    .stats-card:hover{transform:translateY(-3px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    .map-container{border-radius:.75rem;overflow:hidden;height:360px}
    .nav-link{border-radius:.5rem;transition:.2s}
    .nav-link:hover{background:#f1f5f9}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <!-- الشريط العلوي -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2 space-x-reverse">
        <div class="w-10 h-10 rounded-lg bg-emerald-600 text-white grid place-items-center font-bold">م</div>
        <div class="font-extrabold text-xl text-emerald-700">من أجلي</div>
      </div>
      <div class="flex items-center space-x-3 space-x-reverse">
        <div class="text-sm bg-slate-100 px-3 py-1 rounded-full text-slate-700 flex items-center">
          <i class="fas fa-user mr-2 text-emerald-600"></i>
          {% if vol %}
            <span>{{ vol.name }}</span>
          {% elif org %}
            <span>{{ org.name }}</span>
          {% else %}
            <span>{{ request.user.username }}</span>
          {% endif %}
        </div>
        <nav class="flex gap-2">
          <a href="{% url 'home' %}" class="nav-link px-3 py-2 flex items-center">
            <i class="fas fa-home ml-2"></i><span>الرئيسية</span>
          </a>
          <a href="{% url 'logout' %}" class="nav-link px-3 py-2 flex items-center text-rose-600 hover:bg-rose-50">
            <i class="fas fa-sign-out-alt ml-2"></i><span>خروج</span>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">

    {% if messages %}
      <ul class="mb-4 text-sm">
        {% for m in messages %}
          <li class="px-3 py-2 rounded-lg {% if m.tags == 'success' %}bg-emerald-50 text-emerald-700{% else %}bg-rose-50 text-rose-700{% endif %}">{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <!-- رأس -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-slate-800 mb-2">لوحة التحكم</h1>
      {% if vol %}
        <p class="text-slate-600">مرحبًا <b>{{ vol.name }}</b> — مدينتك: <b>{{ vol.city }}</b></p>
      {% elif org %}
        <p class="text-slate-600">مرحبًا <b>{{ org.name }}</b> — مدينتك: <b>{{ org.city }}</b></p>
      {% else %}
        <p class="text-rose-600">حسابك لا يملك بروفايل متطوع أو جهة. تواصل مع الإدارة.</p>
      {% endif %}
    </div>

    <!-- إحصائيات -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="stats-card p-4 text-center">
        <div class="text-2xl font-bold text-emerald-600">{{ assigned_requests|length }}</div>
        <div class="text-sm text-slate-600 mt-1">مُسندة لي</div>
        <div class="mt-2 h-1 w-12 bg-emerald-100 rounded-full mx-auto"></div>
      </div>
      <div class="stats-card p-4 text-center">
        <div class="text-2xl font-bold text-amber-600">{{ suitable_requests|length }}</div>
        <div class="text-sm text-slate-600 mt-1">متاحة (بانتظار)</div>
        <div class="mt-2 h-1 w-12 bg-amber-100 rounded-full mx-auto"></div>
      </div>
      <div class="stats-card p-4 text-center">
        <div class="text-2xl font-bold text-blue-600">5</div>
        <div class="text-sm text-slate-600 mt-1">مكتملة (تجريبي)</div>
        <div class="mt-2 h-1 w-12 bg-blue-100 rounded-full mx-auto"></div>
      </div>
      <div class="stats-card p-4 text-center">
        <div class="text-2xl font-bold text-purple-600">12</div>
        <div class="text-sm text-slate-600 mt-1">إجمالي مساهماتي (تجريبي)</div>
        <div class="mt-2 h-1 w-12 bg-purple-100 rounded-full mx-auto"></div>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- يسار: مُسنّدة + متاحة -->
      <div class="lg:col-span-2 space-y-6">
        <!-- مُسنّدة -->
        <section class="dashboard-card p-5">
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-lg text-slate-800 flex items-center">
              <i class="fas fa-tasks text-emerald-600 ml-2"></i> الطلبات المُسنَدة لي
            </h2>
            <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{{ assigned_requests|length }} طلب</div>
          </div>

          {% if assigned_requests %}
            <div class="space-y-4">
              {% for r in assigned_requests %}
              <a href="{% url 'request_detail' r.pk %}" class="request-card block p-4 bg-white hover:bg-slate-50">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-bold text-slate-800">{{ r.get_type_display }} — {{ r.get_status_display }}</div>
                  <span class="badge badge-assigned flex items-center">
                    <i class="fas fa-user-check ml-1 text-xs"></i>{{ r.get_status_display }}
                  </span>
                </div>
                <div class="text-sm text-slate-600 mb-2 flex items-center">
                  <i class="fas fa-map-marker-alt ml-1 text-slate-400"></i>{{ r.city }}
                </div>
                <div class="text-sm text-slate-600 mb-3 flex items-center">
                  <i class="fas fa-clock ml-1 text-slate-400"></i>{{ r.date }} • {{ r.time|time:"H:i" }}
                </div>
                <div class="text-sm text-slate-700 line-clamp-2">{{ r.desc|truncatechars:120 }}</div>
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-100">
                  <div class="text-xs text-slate-500">#{{ r.id }}</div>
                  <div class="text-xs text-emerald-600 font-medium flex items-center">
                    <span>عرض التفاصيل</span><i class="fas fa-arrow-left mr-1 text-xs"></i>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state p-8 text-center">
              <i class="fas fa-inbox text-4xl text-slate-300 mb-3"></i>
              <p class="text-slate-500 mb-2">لا توجد طلبات مُسنَدة حاليًا</p>
              <p class="text-sm text-slate-400">سيتم عرض الطلبات الموكلة إليك هنا عند توفرها</p>
            </div>
          {% endif %}
        </section>

        <!-- المتاحة -->
        <section class="dashboard-card p-5">
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-lg text-slate-800 flex items-center">
              <i class="fas fa-list-alt text-amber-600 ml-2"></i> الطلبات المتاحة (بانتظار)
            </h2>
            <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{{ suitable_requests|length }} طلب</div>
          </div>

          {% if suitable_requests %}
            <div class="space-y-4">
              {% for r in suitable_requests %}
              <div class="request-card p-4 bg-white">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-bold text-slate-800">{{ r.get_type_display }}</div>
                  <span class="badge badge-available flex items-center">
                    <i class="fas fa-hourglass-half ml-1 text-xs"></i>{{ r.get_status_display }}
                  </span>
                </div>
                <div class="text-sm text-slate-600 mb-2 flex items-center">
                  <i class="fas fa-map-marker-alt ml-1 text-slate-400"></i>{{ r.city }}
                </div>
                <div class="text-sm text-slate-600 mb-3 flex items-center">
                  <i class="fas fa-clock ml-1 text-slate-400"></i>{{ r.date }} • {{ r.time|time:"H:i" }}
                </div>
                <div class="text-sm text-slate-700 mb-4">{{ r.desc|truncatechars:120 }}</div>

                <div class="flex justify-between items-center">
                  <form method="post" action="{% url 'request_accept' r.pk %}">
                    {% csrf_token %}
                    <button class="px-4 py-2 bg-emerald-600 text-white text-sm rounded-lg flex items-center hover:bg-emerald-700">
                      <i class="fas fa-hand-holding-heart ml-2"></i> تقدّم للمساعدة
                    </button>
                  </form>
                  <a href="{% url 'request_detail' r.pk %}" class="text-xs text-slate-500 hover:text-slate-700 flex items-center">
                    <span>عرض التفاصيل</span><i class="fas fa-arrow-left mr-1 text-xs"></i>
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state p-8 text-center">
              <i class="fas fa-search text-4xl text-slate-300 mb-3"></i>
              <p class="text-slate-500 mb-2">لا توجد طلبات متاحة الآن</p>
              <p class="text-sm text-slate-400">سيتم إشعارك عند توفر طلبات جديدة</p>
            </div>
          {% endif %}
        </section>
      </div>

      <!-- يمين: الخريطة + ملاحظات -->
      <div class="space-y-6">
        <section class="dashboard-card p-5">
          <h2 class="font-bold text-lg text-slate-800 mb-4 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 ml-2"></i> الطلبات على الخريطة
          </h2>

          <!-- تأكد أن هذا العنصر ظاهر وليس داخل عنصر مُخفى -->
          <div class="map-container mb-3" style="height:360px">
            <div id="requests-map" class="w-full h-full"></div>
          </div>

          <p class="text-xs text-slate-600 text-center">العلامات تُعرض عند وجود إحداثيات للطلب (lat/lng).</p>
        </section>

        <section class="dashboard-card p-5">
          <h2 class="font-bold text-lg text-slate-800 mb-4 flex items-center">
            <i class="fas fa-info-circle text-purple-600 ml-2"></i> ملاحظات سريعة
          </h2>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>قبول الطلب يُسنده لحسابك ويغيّر الحالة إلى <b>مقبول</b>.</li>
            <li>بدء التنفيذ من <b>مقبول</b> ⟶ <b>قيد التنفيذ</b>، ثم الإنهاء إلى <b>منجز</b>.</li>
            <li>تفاصيل الطلب لا تظهر إلا للمُكلّف أو الموظف (staff).</li>
          </ul>
        </section>
      </div>
    </div>
  </main>

  <script>
    // تهيئة الخريطة والطبقات
    document.addEventListener('DOMContentLoaded', function () {
      const mapEl = document.getElementById('requests-map');
      if (!mapEl) return;

      // إذا كان العنصر داخل تبويب مخفي، قد لا تُحسب الأبعاد — لذا نضمن ارتفاعًا صريحًا
      if (mapEl.clientHeight < 100) {
        mapEl.style.height = '360px';
      }

      const map = L.map('requests-map', {scrollWheelZoom:false}).setView([24.7136,46.6753], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap'}).addTo(map);

      const assignedIcon = L.divIcon({className:'', html:'<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 2px #10b981"></div>', iconSize:[12,12]});
      const pendingIcon  = L.divIcon({className:'', html:'<div style="background:#f59e0b;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 2px #f59e0b"></div>', iconSize:[12,12]});

      const assigned = [
        {% for r in assigned_requests %}
          {% if r.lat and r.lng %}{lat:{{ r.lat|floatformat:"6" }},lng:{{ r.lng|floatformat:"6" }},title:"{{ r.get_type_display }} — {{ r.get_status_display }}", id:{{ r.id }}},{% endif %}
        {% endfor %}
      ];
      const available = [
        {% for r in suitable_requests %}
          {% if r.lat and r.lng %}{lat:{{ r.lat|floatformat:"6" }},lng:{{ r.lng|floatformat:"6" }},title:"{{ r.get_type_display }} — {{ r.get_status_display }}", id:{{ r.id }}},{% endif %}
        {% endfor %}
      ];

      let markers = [];
      assigned.forEach(p => {
        const m = L.marker([p.lat, p.lng], {icon: assignedIcon}).addTo(map);
        m.bindPopup(`<b>${p.title}</b><br><a href="{% url 'request_detail' 0 %}`.replace('0', p.id)+`">التفاصيل</a>`);
        markers.push(m);
      });
      available.forEach(p => {
        const m = L.marker([p.lat, p.lng], {icon: pendingIcon}).addTo(map);
        m.bindPopup(`<b>${p.title}</b><br><a href="{% url 'request_detail' 0 %}`.replace('0', p.id)+`">التفاصيل</a>`);
        markers.push(m);
      });

      if (markers.length) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.3));
      } else {
        // لا نقاط → تركيز عام على السعودية
        map.setView([23.8859,45.0792], 5);
      }

      // إصلاح محتمل عند احتواء الخريطة داخل عناصر تم إظهارها لاحقًا
      setTimeout(() => { map.invalidateSize(); }, 150);
    });
  </script>
</body>
</html>
